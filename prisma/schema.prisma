// 1. CONFIGURATION
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-1.1.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------
//                          MODELS
// ---------------------------------------------------------


// 1. STUDENTS (Users)
model Student {
  id         String   @id @default(uuid())
  fullName   String
  email      String   @unique
  password   String
  dob        String
  university String
  hometown   String
  otp        String?
  isVerified Boolean  @default(false)
  
  // ID Verification
  idCardUrl      String?
  profilePicture String?

  // Relations
  // Output - Relations
  redemptions   Redemption[]
  savedDeals    SavedDeal[]
  notifications Notification[]
  
  // Gamification
  hasSpunWheel  Boolean @default(false)

  createdAt DateTime @default(now())
}

// 2. BUSINESSES (Partners)
model Business {
  id        String @id @default(cuid())
  email     String @unique
  password  String

  // Basic Info
  businessName String
  viewCount    Int      @default(0)
  city         String   @default("London")
  description  String?  @db.Text
  logo         String?
  coverImage   String?
  website      String?
  category     String   @default("Food")
  address      String?
  phone        String?
  role         String?
  
  // ✅ NEW: Google Maps Link
  googleMapsUrl String?

  // ✅ NEW: Google Maps Embed Code
  googleMapEmbed String? @db.Text

  // ✅ NEW: Stripe Subscription Fields
  stripeCustomerId     String?
  stripeSubscriptionId String?
  subscriptionStatus   String?  @default("TRIALING") // TRIALING, ACTIVE, PAST_DUE, CANCELED

  // Location Fields
  latitude  Float @default(0)
  longitude Float @default(0)

  // Additional Info
  placeId         String?
  otp             String?
  isVerified      Boolean  @default(false)
  updatedAt       DateTime @updatedAt
  status          String   @default("PENDING")
  rejectionReason String?  @db.Text

  // Subscription
  plan                 String    @default("free_trial")

  isTrialActive        Boolean   @default(false)
  
  // ✅ Trial Logic Fields
  trialEndsAt   DateTime  @default(dbgenerated("NOW() + interval '3 months'")) 
  isSubscribed  Boolean   @default(false)

  // ✅ Custom Pricing
  customPlanPrice  Float?   

  // Relations
  deals        Deal[]
  pushRequests PushRequest[]
  locations    Location[]
  tickets      Ticket[]

  createdAt DateTime @default(now())
}

// 3. DEALS (Updated Model)
model Deal {
  id              Int      @id @default(autoincrement())
  title           String
  description     String
  category        String  
  subCategory     String? 
  discountValue   String  @default("10%")
  
  // Changed to DateTime? for better query logic, but String is okay if you prefer
  expiry          DateTime? 

  // Image Field
  image           String?
  
  status          String  @default("PENDING") // PENDING, ACTIVE, REJECTED
  views           Int     @default(0) // ✅ Added Views Field
  clicks          Int     @default(0) // ✅ Real Clicks Tracking
  claimed         Int     @default(0) // ✅ Added Claimed Field
  priorityScore   Int     @default(0)
  rejectionReason String? @db.Text
  
  // ✅ NEW FIELDS REQUESTED
  isMultiUse      Boolean   @default(false)
  isUrgent        Boolean   @default(false) // ✅ NEW: Urgent Feature
  redemptionType  String    @default("SWIPE") // 'SWIPE', 'CODE', 'LINK'
  redemptionLink  String?   // ✅ NEW: Online Redemption Link
  
  // ✅ Inventory Management
  stock           Int       @default(10) // Default stock
  isSoldOut       Boolean   @default(false)

  // Relations
  businessId  String
  business    Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  savedBy     SavedDeal[]
  redemptions Redemption[]
  
  // Voucher Relation
  vouchers    Voucher[]
  
  // Gamification
  spinPrizes  SpinPrize[]

  createdAt DateTime @default(now())
}

// 4. PUSH REQUESTS
model PushRequest {
  id           Int       @id @default(autoincrement())
  title        String
  message      String
  status       String    @default("PENDING")
  targetRadius Int       @default(0)
  filters      String?   @db.Text
  businessId   String?
  business     Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdAt    DateTime  @default(now())
  sentAt       DateTime?
}

// 5. LOCATIONS (Additional Branches)
model Location {
  id         Int      @id @default(autoincrement())
  name       String
  address    String
  lat        Float
  lng        Float
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

// 6. SUPPORT TICKETS
model Ticket {
  id         Int      @id @default(autoincrement())
  subject    String
  message    String
  status     String    @default("OPEN")
  createdAt  DateTime  @default(now())
  businessId String
  business   Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

// 7. UNIVERSITIES
model University {
  id        Int      @id @default(autoincrement())
  name      String
  region    String   @default("London")
  latitude  Float
  longitude Float
  campuses  Campus[]
  notes     UniversityNote[]
  createdAt DateTime @default(now())
}

model Campus {
  id           Int        @id @default(autoincrement())
  name         String
  address      String?
  latitude     Float
  longitude    Float
  status       String     @default("ACTIVE")
  universityId Int
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)
}

model UniversityNote {
  id           Int        @id @default(autoincrement())
  content      String     @db.Text
  createdAt    DateTime   @default(now())
  universityId Int
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)
}

// 8. ADMIN
model Admin {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  role      String   @default("SUPER_ADMIN")
  createdAt DateTime @default(now())
}

// 9. OTP CODES
model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

// 10. REDEMPTIONS
model Redemption {
  id        Int      @id @default(autoincrement())
  studentId String
  dealId    Int
  createdAt DateTime @default(now())

  // Relations
  student   Student  @relation(fields: [studentId], references: [id])
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
}

// 11. SAVED DEALS
model SavedDeal {
  id        String   @id @default(uuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])
  dealId    Int
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  savedAt   DateTime @default(now())

  @@unique([studentId, dealId])
}

// 12. CATEGORY SYSTEM
model Category {
  id        Int      @id @default(autoincrement())
  name      String
  type      String   @default("MAIN") // "MAIN" or "SUB"
  parentId  Int?     
  
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")
  
  createdAt DateTime   @default(now())
}

// 13. VOUCHERS (Unique Codes)
model Voucher {
  id        String   @id @default(cuid())
  code      String   @unique // The unique code (e.g. "SL-BURGER-8X2A")
  isUsed    Boolean  @default(false)
  
  studentId String
  // Relation to Deal (Int ID)
  dealId    Int
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  expiresAt DateTime? // ✅ 14-Day Expiry Rule
}

// 14. SPIN THE WHEEL & GAMIFICATION
model SpinPrize {
  id        String   @id @default(cuid())
  name      String
  type      String   @default("LOSE") // WIN, LOSE, TRY_AGAIN
  weight    Int      @default(1)
  quantity  Int      @default(0) // Remaining stock
  
  // Linked Deal (if type == WIN)
  dealId    Int?
  deal      Deal?    @relation(fields: [dealId], references: [id])
  
  wins      Int      @default(0) // Total times won
  createdAt DateTime @default(now())
}

// 15. NOTIFICATIONS
model Notification {
  id        String   @id @default(cuid())
  
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  title     String
  message   String
  type      String   @default("SYSTEM") // DEAL, SYSTEM, WIN
  dealId    Int?     // Link to deal if applicable
  
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}