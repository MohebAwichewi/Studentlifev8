// 1. CONFIGURATION (Handles Windows PC + Linux/cPanel Server)
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------
//                          MODELS
// ---------------------------------------------------------

// 1. STUDENTS (Updated with Auth & Profile Fields)
model Student {
  id         String   @id @default(uuid())
  fullName   String
  email      String   @unique
  password   String   // In production, hash this!
  dob        String
  university String
  hometown   String
  otp        String?  // Stores the temporary code
  isVerified Boolean  @default(false)
  
  // ✅ EXISTING RELATION
  redemptions Redemption[]
  
  // ✅ NEW RELATION: Saved Deals (Favorites)
  savedDeals  SavedDeal[] 

  createdAt  DateTime @default(now())
}

// 2. BUSINESSES (Main Partner Model - Updated with City & Stripe)
model Business {
  // ✅ Changed to String CUID as requested
  id                   String   @id @default(cuid())
  
  email                String   @unique
  password             String
  
  // Basic Info
  businessName         String   
  // ✅ NEW: Exposure Counter (Real Analytics)
  viewCount            Int      @default(0)
  // ✅ NEW FIELD ADDED HERE
  city                 String   @default("Tunis") 

  // ✅ EXISTING FIELDS PRESERVED
  description          String?  @db.Text 
  logo                 String?  // URL to image
  coverImage           String?  // URL to image
  website              String?
  category             String   @default("Food")
  address              String?  // Added this as it's used in your signup form
  phone                String?  // Added this as it's used in your signup form
  role                 String?  // Added for 'Owner' role tracking

  // Status (Visible in Admin)
  status               String   @default("PENDING") 
  
  // ✅ NEW: Store rejection reason if status is REJECTED
  rejectionReason      String?  @db.Text 
  
  // Subscriptions & Billing (UPDATED)
  plan                 String    @default("FREE") 
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?
  isTrialActive        Boolean   @default(false)
  trialEnds            DateTime?
  
  // Relations
  deals        Deal[]
  pushRequests PushRequest[]
  locations    Location[]      
  tickets      Ticket[]        
  
  // ✅ EXISTING RELATION
  redemptions  Redemption[]
  
  createdAt    DateTime @default(now())
}

// 3. DEALS (Offers created by businesses)
model Deal {
  id            Int      @id @default(autoincrement())
  title         String
  description   String
  category      String
  expiry        String   
  image         String?
  
  // ✅ NEW: Status (Default is PENDING, must be approved to go live)
  status        String   @default("PENDING") 
  
  // ✅ NEW: Priority Score (Higher = Shows first)
  priorityScore Int      @default(0) 

  // ✅ NEW: Store rejection reason if status is REJECTED
  rejectionReason String?  @db.Text 

  // ✅ Relation updated to String to match Business ID
  businessId    String
  business      Business @relation(fields: [businessId], references: [id])
  
  // ✅ NEW RELATION: Tracks which students saved this deal
  savedBy       SavedDeal[] 
  
  createdAt     DateTime @default(now())
}

// 4. PUSH REQUESTS (Notification Campaigns)
model PushRequest {
  id           Int      @id @default(autoincrement())
  title        String
  message      String
  status       String   @default("PENDING") 
  targetRadius Int      @default(0) 

  // ✅ Relation updated to String to match Business ID
  businessId   String
  business     Business @relation(fields: [businessId], references: [id])
  
  createdAt    DateTime @default(now())
  sentAt       DateTime? 
}

// 5. LOCATIONS (Physical Branches)
model Location {
  id         Int      @id @default(autoincrement())
  name       String   
  address    String
  lat        Float
  lng        Float
  
  // ✅ Relation updated to String to match Business ID
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
}

// 6. SUPPORT TICKETS
model Ticket {
  id        Int      @id @default(autoincrement())
  subject   String
  message   String
  status    String   @default("OPEN") 
  createdAt DateTime @default(now())
  
  // ✅ Relation updated to String to match Business ID
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
}

// 7. UNIVERSITIES (Updated with Campuses & Notes)
model University {
  id        Int      @id @default(autoincrement())
  name      String
  region    String   @default("Tunis") 
  latitude  Float
  longitude Float
  
  // ✅ Relation to multiple campuses
  campuses  Campus[]
  
  // ✅ Relation to Notes
  notes     UniversityNote[]
  
  createdAt DateTime @default(now())
}

// ✅ NEW MODEL: CAMPUS (Updated with Status)
model Campus {
  id           Int        @id @default(autoincrement())
  name         String     // e.g. "Ghazala Campus", "Charguia"
  address      String?
  latitude     Float
  longitude    Float
  
  // ✅ NEW: Status Field
  status       String     @default("ACTIVE") // Values: ACTIVE, CLOSED, MAINTENANCE
  
  universityId Int
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)
}

// ✅ NEW MODEL: University Notes
model UniversityNote {
  id           Int        @id @default(autoincrement())
  content      String     @db.Text
  createdAt    DateTime   @default(now())
  
  universityId Int
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)
}

// 8. ADMIN (Dashboard Access)
model Admin {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  role      String   @default("SUPER_ADMIN")
  createdAt DateTime @default(now())
}

// 9. OTP CODES (Generic Verification Tokens)
model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

// 10. REDEMPTIONS (Real Tracking of In-Store Usage)
model Redemption {
  id         String   @id @default(uuid())
  
  // Who used it?
  studentId  String
  student    Student  @relation(fields: [studentId], references: [id])
  
  // Where was it used?
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  
  // When?
  redeemedAt DateTime @default(now())
}

// 11. SAVED DEALS (New Feature - Favorites)
model SavedDeal {
  id        String   @id @default(uuid())
  
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])
  
  dealId    Int
  deal      Deal     @relation(fields: [dealId], references: [id])
  
  savedAt   DateTime @default(now())

  // Prevents a student from saving the same deal more than once
  @@unique([studentId, dealId]) 
}