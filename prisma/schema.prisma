generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-1.1.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String       @id @default(uuid())
  fullName    String
  email       String       @unique
  password    String
  dob         String?
  university  String?
  hometown    String?
  otp         String?
  isVerified  Boolean      @default(false)
  isBanned    Boolean      @default(false)
  createdAt   DateTime     @default(now())
  city        String?
  otpExpiry   DateTime?
  phone       String?      @unique
  updatedAt   DateTime     @default(now()) @updatedAt
  pushToken   String?
  follows     Follow[]
  redemptions Redemption[]
  savedDeals  SavedDeal[]
  tickets     Ticket[]
}

model Business {
  id                   String   @id @default(cuid())
  email                String   @unique
  password             String
  businessName         String
  viewCount            Int      @default(0)
  city                 String   @default("Tunis")
  description          String?
  logo                 String?
  coverImage           String?
  website              String?
  category             String   @default("Food")
  address              String?
  phone                String?
  role                 String?
  googleMapsUrl        String?
  googleMapEmbed       String?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  subscriptionStatus   String?  @default("TRIALING")
  latitude             Float    @default(0)
  longitude            Float    @default(0)
  placeId              String?
  otp                  String?
  isVerified           Boolean  @default(false)
  updatedAt            DateTime @updatedAt
  status               String   @default("PENDING")
  rejectionReason      String?
  plan                 String   @default("free_trial")
  isTrialActive        Boolean  @default(false)
  trialEndsAt          DateTime @default(dbgenerated("(now() + '3 mons'::interval)"))
  isSubscribed         Boolean  @default(false)
  customPlanPrice      Float?
  createdAt            DateTime @default(now())

  // Settings & Preferences
  language           String  @default("en") // en, fr, ar
  timezone           String  @default("Africa/Tunis")
  emailNotifications Boolean @default(true)
  pushNotifications  Boolean @default(true)

  openingHours   String?
  deals          Deal[]
  follows        Follow[]
  locations      Location[]
  pushRequests   PushRequest[]
  tickets        Ticket[]
  supportTickets SupportTicket[]
  Notification   Notification[]
}

model Deal {
  id               Int           @id @default(autoincrement())
  title            String
  description      String
  category         String
  expiry           DateTime?
  image            String?
  businessId       String
  createdAt        DateTime      @default(now())
  discount         String
  isActive         Boolean       @default(true)
  isFeatured       Boolean       @default(false)
  isPriority       Boolean       @default(false)
  subCategory      String?
  isMultiUse       Boolean       @default(false)
  maxClaimsPerUser Int?          @default(1)
  totalInventory   Int?
  images           String[]
  isFlashDeal      Boolean       @default(false)
  clicks           Int           @default(0)
  isDraft          Boolean       @default(false)
  startDate        DateTime?
  originalPrice    Float         @default(0) // ✅ NEW: For "Amount to Collect" calculation
  views            Int           @default(0)
  business         Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  redemptions      Redemption[]
  savedDeals       SavedDeal[]
  tickets          Ticket[]
  vouchers         Voucher[]
  locations        Location[] // Many-to-Many with Location
  pushRequests     PushRequest[]
}

model Ticket {
  id         Int       @id @default(autoincrement())
  createdAt  DateTime  @default(now())
  businessId String
  code       String    @unique
  dealId     Int
  isUsed     Boolean   @default(false)
  qrData     String
  usedAt     DateTime?
  userId     String
  business   Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  deal       Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dealId])
}

model PushRequest {
  id              Int       @id @default(autoincrement())
  title           String
  message         String
  status          String    @default("PENDING")
  targetRadius    Int       @default(0)
  filters         String?
  businessId      String?
  createdAt       DateTime  @default(now())
  sentAt          DateTime?
  dealId          Int?
  rejectionReason String?
  business        Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  deal            Deal?     @relation(fields: [dealId], references: [id])
}

model Notification {
  id         String   @id @default(uuid())
  type       String // FOLLOW, EXPIRY, SOLD_OUT, RENEWAL, SYSTEM, PERFORMANCE
  title      String
  message    String
  isRead     Boolean  @default(false)
  businessId String
  createdAt  DateTime @default(now())
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model SupportTicket {
  id         String   @id @default(uuid())
  businessId String
  subject    String
  message    String
  priority   String   @default("NORMAL")
  status     String   @default("OPEN")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model Location {
  id         Int      @id @default(autoincrement())
  name       String
  address    String
  lat        Float
  lng        Float
  businessId String
  createdAt  DateTime @default(now())
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  deals      Deal[] // Many-to-Many with Deal
}

model University {
  id       Int                @id @default(autoincrement())
  name     String             @unique
  city     String
  campuses UniversityCampus[]
  notes    UniversityNote[]
}

model UniversityCampus {
  id           Int        @id @default(autoincrement())
  name         String
  address      String?
  latitude     Float
  longitude    Float
  status       String     @default("ACTIVE")
  universityId Int
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)
}

model UniversityNote {
  id           Int        @id @default(autoincrement())
  content      String
  createdAt    DateTime   @default(now())
  universityId Int
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)
}

model Admin {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  role      String   @default("SUPER_ADMIN")
  createdAt DateTime @default(now())
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

model Redemption {
  id             Int      @id @default(autoincrement())
  userId         String
  dealId         Int
  createdAt      DateTime @default(now())
  redeemedAmount Float    @default(0) // ✅ NEW: Freezes the "Amount Collected" at transaction time
  deal           Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id])
}

model SavedDeal {
  id      String   @id @default(uuid())
  userId  String
  dealId  Int
  savedAt DateTime @default(now())
  deal    Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id])

  @@unique([userId, dealId])
}

model Category {
  id        Int        @id @default(autoincrement())
  name      String
  type      String     @default("MAIN")
  parentId  Int?
  createdAt DateTime   @default(now())
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")
}

model Voucher {
  id        String   @id @default(cuid())
  code      String   @unique
  isUsed    Boolean  @default(false)
  dealId    Int
  createdAt DateTime @default(now())
  userId    String
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dealId])
}

model City {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  nameAr    String?
  region    String?
  latitude  Float?
  longitude Float?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Follow {
  id         String   @id @default(uuid())
  userId     String
  businessId String
  createdAt  DateTime @default(now())
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
  @@index([userId])
  @@index([businessId])
}

model HomepageConfig {
  id        Int      @id @default(autoincrement())
  section   String   @unique
  content   String
  updatedAt DateTime @updatedAt
}
